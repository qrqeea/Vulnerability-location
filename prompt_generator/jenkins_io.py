import requests
from bs4 import BeautifulSoup

def handleText(input):
    # 以换行符为分隔符，将字符串分割成行
    lines = input.split('\n')

    # 去除每行前后的空格，并过滤掉空行
    stripped_lines = [line.strip() for line in lines if line.strip()]

    # 将处理后的内容合并为一个字符串
    result = '\n'.join(stripped_lines)
    return result


def generate_prompt(url: str):

    prompt = '''
I will give you some information about a software vulnerability. The information includes these parts: Descriptions, Severity, Affected Versions, Fix, and Credit. Note that some parts may not exist. You need to extract the valuable parts from the information. The focus is on the information section describing the vulnerability.\n\n'''[1:]

    try:
        res = requests.get(url)
        soup = BeautifulSoup(res.text, 'html.parser')

        info = soup.find_all(name = 'div', attrs = {
            'class' : 'sect1',
        })

        if info == None:
            for index, item in enumerate(info):
                prompt += '{' + item.h2.text + '}:\n' + handleText(item.div.text) + '\n\n'
        else:
            info = soup.find(name = 'div', attrs = {
                'class' : 'col-lg-9',
            })
            target_tag = info.h2
            # print(target_tag.text)
            for sibling in target_tag.find_previous_siblings():
                sibling.extract()
            # print(handleText(info.text))
            prompt += handleText(info.text) + '\n\n'
    except Exception as e:
        return None

    return prompt

if __name__ == '__main__':
    url = 'https://www.jenkins.io/security/advisory/2019-09-12/#SECURITY-1538'
    prompt = generate_prompt(url)
    if prompt != None:
        with open('./prompt_template/prompt_test/jenkins.io', 'w') as f:
            print(prompt, file = f)