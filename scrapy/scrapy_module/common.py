import requests
from bs4 import BeautifulSoup
from util.io_util import format_text, save_text


def scrapy(url: str):
    res = ''
    if url in [
        'https://wordpress.org/plugins/print-my-blog/#developers',
        'https://wordpress.org/plugins/google-calendar-events/changelog',
        'https://wordpress.org/plugins/quiz-master-next/#developers',
        'http://typo3.org/extensions/repository/view/powermail',
        'http://www.us-cert.gov/cas/techalerts/TA06-107A.html',
        'http://www.us-cert.gov/cas/techalerts/TA07-072A.html',
        'http://www.us-cert.gov/cas/techalerts/TA07-352A.html',
        'http://www.us-cert.gov/cas/techalerts/TA06-132A.html',
        'http://www.us-cert.gov/cas/techalerts/TA06-129A.html',
        'http://www.us-cert.gov/cas/techalerts/TA06-075A.html',
        'http://www.us-cert.gov/cas/techalerts/TA06-333A.html',
        'https://community.openvpn.net/openvpn/wiki/ChangesInOpenvpn24',
        'http://www.mpxj.org/changes-report.html#a8.3.5',
        'https://bugzilla.mozilla.org/show_bug.cgi?id=1160890',
        'https://bugzilla.mozilla.org/show_bug.cgi?id=1140537',
        'https://bugzilla.kernel.org/show_bug.cgi?id=200179',
        'https://bugzilla.kernel.org/show_bug.cgi?id=199183',
        'http://lxml.de/3.3/changes-3.3.5.html',
        'http://www.openssl.org/news/vulnerabilities.html',
        'http://libvirt.org/news.html',
        'http://svn.php.net/viewvc/php/php-src/branches/PHP_5_3/NEWS?view=markup&pathrev=312103',
        'http://augeas.net/news.html',
        'https://cryptography.io/en/latest/changelog',
        'http://us2.php.net/ChangeLog-4.php#4.4.4',
        'https://sourceware.org/bugzilla/show_bug.cgi?id=18665',
        'http://hg.code.sf.net/p/graphicsmagick/code/file/233618f8fe82/ChangeLog',
        'https://research.nccgroup.com/2021/11/08/technical-advisory-arbitrary-signature-forgery-in-stark-bank-ecdsa-libraries/',
        'https://security-center.intel.com/advisory.aspx?intelid=INTEL-SA-00062&languageid=en-fr',
        'http://www-304.ibm.com/support/docview.wss?uid=swg21960041'
    ]:
        return res
    if 'pypi.python.org/pypi/Pillow' in url:
        return res
    
    soup = BeautifulSoup(requests.get(url).text, 'html.parser')
    info = soup.body
    if info != None:
        # print(info.text)
        res += format_text(info.text)
    elif url == 'https://bugzilla.suse.com/attachment.cgi?id=844938':
        res += str(soup.contents)

    if 'bugs.php.net/bug.php?id=76130' in url:
        l = res.find('Test script')
        r = res.find('Actual result')
        res = res[:l] + res[r:]

        l = res.find('Base64')
        r = res.find('Thanks for the')
        res = res[:l] + res[r:]

    return res


if __name__ == '__main__':
    # with open('/Volumes/NVD/experiment_data/datasets/completion/url_list/typo3.org', 'r') as f:
    #     data = f.readlines()

    # for url in data:
    #     url = url.strip()
    #     res = scrapy(url)
    #     print(len(res))

    url = 'https://mantisbt.org/bugs/view.php?id=15453'
    res = scrapy(url)
    print(res)
    # save_text('tp', res)