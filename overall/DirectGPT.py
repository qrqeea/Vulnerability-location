import os
import tqdm
import random
from util.io_util import *
from util.general_util import *
from util.similarity_util import *


class DirectGPT:

    def __init__(self, module_root_path: str, cve_data_all: dict, correct_commits: dict):
        self.module_root_path = module_root_path
        self.cve_data_all = cve_data_all
        self.correct_commits = correct_commits
        self.cve_list = [   # 121
            cve
            for cve in self.cve_data_all
            if 'collected_commit' not in self.cve_data_all[cve]
        ]
        # self.cve_list = list(cve_data_all.keys())     # 8861

        self.cve_list = [   # 5921
            cve
            for cve in self.cve_data_all
            if 'complete_description' in self.cve_data_all[cve]
        ]

        os.makedirs(self.module_root_path, exist_ok = True)

        self.prompt_dir = f'{self.module_root_path}/prompt_completion'
        os.makedirs(self.prompt_dir, exist_ok = True)

        self.result_dir = f'{self.module_root_path}/result_completion'
        os.makedirs(self.result_dir, exist_ok = True)


    def start(self):
        # for cve in os.listdir(f'{self.result_dir}'):
        #     if cve in ['.DS_Store']:
        #         continue
        #     if cve not in self.cve_data_all:
        #         print(cve)

        # self.generate_prompt()
        # self.count_total_tokens()
        self.query_gpt()
        # self.check_result()


    def generate_prompt(self):
        prompt_teplate = load_file(f'{self.module_root_path}/prompt_template')

        for cve in self.cve_list:
            if 'complete_description' in self.cve_data_all[cve]:
                prompt = prompt_teplate.replace('{CVE}', cve).replace('{description}', self.cve_data_all[cve]['complete_description']).replace('{CPE}', self.cve_data_all[cve]['cpe_uri'][0]).replace('{url}', '\n'.join(self.cve_data_all[cve]['reference_list']))
                save_text(f'{self.prompt_dir}/{cve}', prompt)


    def query_gpt(self):
        cve_list_done = {
            cve for cve in os.listdir(f'{self.result_dir}')
            if cve not in ['.DS_Store', 'error_list']
        }
        cve_list = list(set(self.cve_list) - cve_list_done)
        print(f'rest cve list size: {len(cve_list)}')

        def query_gpt_sub(cve_list_sub: list):
            # for cve in tqdm.tqdm(random.sample(cve_list_sub, 4)):
            for cve in tqdm.tqdm(cve_list_sub):
                if os.path.exists(f'{self.result_dir}/{cve}'):
                    continue
                prompt = load_file(f'{self.prompt_dir}/{cve}')
                # token = calc_token(prompt, model = 'gpt-4-turbo')
                # if token > 128000:
                #     continue
                try:
                    res = query_openai(prompt)      # model = 'gpt-4o-2024-05-13'
                    save_text(f'{self.result_dir}/{cve}', res)
                except Exception as e:
                    save_text(f'{self.result_dir}/error_list', f'{cve}\n\n{e}', 'a')

        multi_thread(cve_list, query_gpt_sub, chunk_size = 300)


    def check_result(self):
        totoal_cnt = 0
        correct_cnt = [0, 0, 0, 0, 0]
        for cve in os.listdir(self.result_dir):
            if cve in ['.DS_Store', 'error_list']:
                continue
            try:
                res = load_file(f'{self.result_dir}/{cve}')
                res = res.replace('```json', '').replace('```', '')
                res = json.loads(res)
                totoal_cnt += 1
                repo = res['repository']
                if repo in self.cve_data_all[cve]['vulnerability_files']:
                    for index, file in enumerate(res['files'][:5]):
                        if file.lower() == self.cve_data_all[cve]['vulnerability_files'][repo][0].lower():
                            # if index == 0:
                            #     print(cve, f'{self.result_dir}/{cve}')
                            correct_cnt[index] += 1
                # elif cve in self.correct_commits and repo in self.correct_commits[cve]:
                #     for index, file in enumerate(res['files'][:5]):
                #         if file.lower() == self.correct_commits[cve][repo].lower():
                #             correct_cnt[index] += 1
                else:
                    pass
                    # print(cve, f'{self.result_dir}/{cve}')
                    # print(ans)
                    # print()
            except Exception as e:
                print(f'error, {cve}, {e}, {self.result_dir}/{cve}')
        
        sum = 0
        for index, cnt in enumerate(correct_cnt):
            sum += cnt
            print(f'k = {index + 1}', '{:.2f}%'.format(sum / totoal_cnt * 100), f'({sum}/{totoal_cnt})')


    def count_total_tokens(self):
        cve_list_done = {
            cve for cve in os.listdir(f'{self.result_dir}')
            if cve not in ['.DS_Store', 'error_list']
        }
        cve_list = list(set(self.cve_list) - cve_list_done)
        print(f'rest cve list size: {len(cve_list)}')

        tokens = 0
        for cve in tqdm.tqdm(cve_list):
            prompt = load_file(f'{self.prompt_dir}/{cve}')
            token = calc_token(prompt, model = 'gpt-3.5-turbo')
            # if token > 128000:
            #     continue
            tokens += token
        token_M = int(tokens / 1000000)
        print(f'total token: {token_M}M, price: {token_M * 0.5}$')