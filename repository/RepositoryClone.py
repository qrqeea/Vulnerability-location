import tqdm
import random
from util import *
from common.github_util import *


class RepositoryClone:

    def __init__(self, module_root_path: str, cve_data_all: dict):
        self.module_root_path = module_root_path
        self.cve_data_all = cve_data_all

        self.cloned_repo_dir = f'{self.module_root_path}/repo_all'
        os.makedirs(self.cloned_repo_dir, exist_ok = True)

        self.target_dir = f'{self.module_root_path}/target'
        os.makedirs(self.target_dir, exist_ok = True)

        repo_all = set()
        for _, v in self.cve_data_all.items():
            if 'collected_repo' in v:
                for repo in v['collected_repo']:
                    repo_all.add(repo)

        # print(len(repo_all))
        self.repo_all = repo_all


    def start(self):
        # self.clone_all_repo()
        self.clone_specified_repo()
        self.clone_specified_repo_file_list()

    
    def clone_all_repo(self):
        for repo_full_name in tqdm.tqdm(self.repo_all):
            # print(repo_full_name)
            repo_full_name_updated = repo_full_name.replace('/', '—')
            # print(repo_full_name_updated)

            dest_dir = f'{self.cloned_repo_dir}/{repo_full_name_updated}'
            if os.path.exists(dest_dir):
                continue
            # cmd = f'git clone --depth=1 {url}.git {path}/{repo_full_name_updated}'
            cmd = f'git clone --depth=1 git@github.com:{repo_full_name}.git {dest_dir}'
            if os.system(cmd) != 0:
                save_text(f'{self.cloned_repo_dir}/error_list', repo_full_name, 'a')

    
    def clone_specified_repo(self):
        for cve, v in tqdm.tqdm(self.cve_data_all.items()):
            if 'collected_commit' not in v: continue
            
            collected_commit = v['collected_commit']
            dir_name = f'{self.target_dir}/{cve}'
            os.makedirs(dir_name, exist_ok = True)
            
            for repo_full_name, sha in collected_commit:
                repo_full_name_updated = repo_full_name.replace('/', '—')
                dest_path_repo = f'{dir_name}/{repo_full_name_updated}'
                # if os.path.exists(dest_path_repo):
                #     continue
                source_path_repo = f'{self.cloned_repo_dir}/{repo_full_name_updated}'

                cmd1 = f'cd {source_path_repo} && git fetch origin {sha} --depth=1 1>/dev/null'
                cmd2 = f'cd {source_path_repo} && git clean -fd && git checkout . 1>/dev/null'
                cmd3 = f'cd {source_path_repo} && git checkout {sha} 1>/dev/null'
                # print(111, cmd)
                if os.system(cmd1) != 0:
                    save_text(f'{self.target_dir}/error_list', f'cmd1, {cve}, {repo_full_name}', 'a')
                    continue
                if os.system(cmd2) != 0:
                    save_text(f'{self.target_dir}/error_list', f'cmd2, {cve}, {repo_full_name}', 'a')
                    continue
                if os.system(cmd3) != 0:
                    save_text(f'{self.target_dir}/error_list', f'cmd3, {cve}, {repo_full_name}', 'a')
                    continue

                if not os.path.exists(dest_path_repo):
                    os.mkdir(dest_path_repo)

                # cmd = f"rsync -a --exclude='.git' {source_path_repo} {dir_name}"
                # # print(444, cmd)
                
                # if os.system(cmd) != 0:
                #     save_text(f'{self.target_dir}/error_list', (cve, repo_full_name), 'a')
        

    def clone_specified_repo_file_list(self):
        if os.path.exists(f'{self.module_root_path}/repo_file_list.pkl'):
            return
        
        def clone_specified_repo_file_list_sub(cve_list_sub: list, token: str):
            for (repo, sha) in tqdm.tqdm(cve_list_sub):
                repo_file_list[(repo, sha)] = get_file_list(repo, sha, token)

        repo_file_list = {}

        data_list = list(
            { (repo, sha) for _, v in self.cve_data_all.items() if 'collected_commit' in v for (repo, sha) in v['collected_commit']}
        )
        multi_thread(data_list, clone_specified_repo_file_list_sub, tokens = github_tokens)

        save_text(f'{self.module_root_path}/repo_file_list', repo_file_list)
        save_pickle(f'{self.module_root_path}/repo_file_list.pkl', repo_file_list)