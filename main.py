import os
from ground_truth.GroundTruth import GroundTruth
from dataset.preprocessing_data import preprocessing_data
from scrapy.Scrapy import Scrapy
from completion.completion import Completion
from repository.RepositoryCollection import RepositoryCollection
from repository.RepositoryClone import RepositoryClone
from commit.CommitCollection import CommitCollection
from extraction.ComponentExtraction import ComponentExtraction
from candidate.CandidateSelection import CandidateSelection
from util.io_util import load_pickle, load_json
from location.FileLocation import FileLocation
# from codebert.Ablation import CodeBertAblation
# from codebert.TrainingSet import TrainingSet
from overall.DirectGPT import DirectGPT

project_root_path = '/Volumes/NVD/experiment_data'
os.makedirs(project_root_path, exist_ok = True)

cve_json_path = f'{project_root_path}/cve_json'
cpe_json_path = f'{project_root_path}/cpe_json'

# ground_truth = GroundTruth(
#     f'{project_root_path}/ground_truth',
#     f'{project_root_path}/repo_data/repo_file_list',
# )
# ground_truth.start()

# cve_data_all = preprocessing_data(
#     load_json(f'{project_root_path}/ground_truth/ground_truth.json'),
#     project_root_path,
#     cve_json_path,
#     cpe_json_path
# )
# print(len(cve_data_all))    # 8860

# scrapy = Scrapy(
#     project_root_path,
#     f'{project_root_path}/scrapy',
#     load_pickle(f'{project_root_path}/cve_data_all.pkl')
# )
# scrapy.start()

# completion = Completion(
#     project_root_path,
#     f'{project_root_path}/completion',
#     f'{project_root_path}/scrapy/scrapy_result',
#     load_pickle(f'{project_root_path}/cve_data_all.pkl'),
#     16385
# )
# completion.start()

# repositoryCollection = RepositoryCollection(
#     project_root_path,
#     f"{project_root_path}/repository_collection",
#     f'{project_root_path}/repo_data',
#     load_pickle(f'{project_root_path}/cve_data_all.pkl')
# )
# repositoryCollection.start()

commitCollection = CommitCollection(
    project_root_path,
    f'{project_root_path}/commit',
    f'{project_root_path}/repo_data',
    f'{project_root_path}/ground_truth/gt_file_content',
    f'{project_root_path}/repository/target2',
    load_pickle(f'{project_root_path}/cve_data_all.pkl')
)
commitCollection.start()

# repositoryClone = RepositoryClone(
#     f'{project_root_path}/repository',
#     f'{project_root_path}/repo_data',
#     load_pickle(f'{project_root_path}/cve_data_all.pkl'),
#     load_pickle('/Volumes/NVD/experiment_data/commit/cve_list_check_by_content.pkl'),
#     # load_pickle(f'{project_root_path}/commit/rest_cve_list_1914.pkl'),
#     # load_pickle(f'{project_root_path}/retrieval/components/function/cve_list.pkl'),
#     # list(load_pickle(f'{project_root_path}/retrieve/filtered_files.pkl').keys())
#     # list(load_pickle(f'{project_root_path}/retrieve/candidates.pkl').keys())
# )
# repositoryClone.start()

# componentExtraction = ComponentExtraction(
#     project_root_path,
#     f'{project_root_path}/extraction',
#     f'{project_root_path}/completion/completion_result',
#     load_json(f'{project_root_path}/cve_data_all.json')
# )
# componentExtraction.start()

# candidateSelection = CandidateSelection(
#     f'{project_root_path}/retrieval',
#     f'{project_root_path}/repository/target2',
#     load_json(f'{project_root_path}/cve_data_all.json'),
#     load_pickle(f'{project_root_path}/repo_data/repo_file_list.pkl'),
#     load_pickle(f'{project_root_path}/commit/correct_commits.pkl')
# )
# candidateSelection.start()

# location = FileLocation(
#     f'{project_root_path}/location',
#     f'{project_root_path}/repository_clone/target',
#     load_json(f'{project_root_path}/cve_data_all.json'),
#     load_pickle(f'{project_root_path}/retrieve/candidates.pkl'),
# )
# location.start()

# codebert = CodeBertAblation(
#     f'{project_root_path}/codebert_ablation',
#     f'{project_root_path}/repository_clone/target',
#     load_json(f'{project_root_path}/cve_data_all.json'),
#     load_pickle(f'{project_root_path}/retrieve/candidates.pkl'),
#     load_pickle(f'{project_root_path}/repo_data/repo_file_list.pkl')
# )
# codebert.start()

# codebert = TrainingSet(
#     f'{project_root_path}/codebert',
#     f'{project_root_path}/repository_clone/target',
#     load_json(f'{project_root_path}/cve_data_all.json'),
#     list(load_pickle(f'{project_root_path}/retrieve/filtered_files.pkl').keys()),
#     load_pickle(f'{project_root_path}/repo_data/repo_file_list.pkl')
# )
# codebert.start()

# directGPT = DirectGPT(
#     f'{project_root_path}/overall',
#     load_json(f'{project_root_path}/cve_data_all.json'),
#     load_pickle(f'{project_root_path}/commit/correct_commits.pkl')
#     # list(load_pickle(f'{project_root_path}/retrieve/filtered_files.pkl').keys())
# )
# directGPT.start()