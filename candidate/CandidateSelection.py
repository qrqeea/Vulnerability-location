import os
import sys
import tqdm
import random
import difflib
from util.io_util import *
from util.similarity_util import *

class CandidateSelection:

    def __init__(self, project_root_path: str, module_root_path: str, cve_data_all: dict, repo_file_list: dict):
        self.project_root_path = project_root_path
        self.module_root_path = module_root_path
        self.cve_data_all = cve_data_all
        self.repo_file_list = repo_file_list

        self.filter_file_pattern = [
            'changelog', 'news', 'changes', 'changelog', 'version', 'readme', 'makefile', 'license', 'authors', 'todo', 'TODO', 'history', 'copying', 'relnotes', 'thanks', 'notice','whatsnew', 'notes', 'release_notes', 'note', 'testlist', 'testsuite', 'test', '.gitignore', '.xlsx', '.xls', '.md', '.txt', '.doc', '.docx', '.pdf', '.rst', '.changes', '.rdoc', '.mdown', '.command', '.out', '.err', '.stderr', '.stdout', '.test', '.jpg', '.jpeg', '.png', '.svg', '.mp4', '.gif', '.exr', '.csv', '.rdf', '.ico', '.ttf', '.otf', '.woff', '.woff2', '.mock', '.stub', '.fake', '.ppt', '.pptx', '.key', '.bak', '.zip', '.gz', '.rar', '.bmp', '.yaml', '.yml', '.json', '.xml', '.ini', '.cfg', '.tar.gz', '.tgz', '.html', '.htm', '.css', '.cygport', 'logo.', 'ui.js', 
        ]

        self.filter_list_suffix = [
            '.lib'
        ]

        os.makedirs(self.module_root_path, exist_ok = True)

        self.cve_list_dir = f'{self.module_root_path}/cve_list'
        os.makedirs(self.cve_list_dir, exist_ok = True)


    def start(self):
        res = self.select_by_single_component('File', 100)
        # res = load_json('/Volumes/NVD/experiment_data/datasets/candidate/deprecated/candidates_with_[\'File\']_component_1560_100_SequenceMatcher.json')
        self.check_accuracy(res, 1)
        self.check_accuracy(res, 2)
        self.check_accuracy(res, 3)
        self.check_accuracy(res, 4)
        self.check_accuracy(res, 5)
        self.check_accuracy(res, 10)
        self.check_accuracy(res, 50)
        self.check_accuracy(res, 100)
        # res = self.select_by_single_component('Module')
        # res = self.select_by_single_component('Function')

        # res = self.select_by_file_and_function(200)
        # self.check_accuracy(res, 1)
        # self.check_accuracy(res, 3)
        # self.check_accuracy(res, 5)
        # self.check_accuracy(res, 4)
        # self.check_accuracy(res, 50)
        # self.check_accuracy(res, 100)
        # self.test()


    def filter_cve_list(self, component_type_list: list):
        file_path = f'{self.cve_list_dir}/{component_type_list}'
        if os.path.exists(file_path):
            return load_pickle(f'{file_path}.pkl')
        
        cve_list = []
        for cve, v in self.cve_data_all.items():
            components = v.get('components')
            if components:
                collected_commit = v.get('collected_commit')
                if all(components.get(component_type) for component_type in component_type_list) and collected_commit:
                    cve_list.append(cve)
        save_text(file_path, cve_list)
        save_pickle(f'{file_path}.pkl', cve_list)
        return cve_list


    def select_by_single_component(self, component_type: str, k: int, cve_list: list = None, similarity_algorithm = difflib.SequenceMatcher):
        component_type_list = [component_type]
        if not cve_list:
            cve_list = self.filter_cve_list(component_type_list)
        res_path = f'{self.module_root_path}/candidates_with_{component_type_list}_component_{len(cve_list)}_{k}_{similarity_algorithm.__name__}.json'
        if os.path.exists(res_path):
            return load_json(res_path)

        def select_by_single_component_sub(cve_list_sub: list):
            for cve in tqdm.tqdm(cve_list_sub):
            # for cve in random.sample(cve_list, 50):
            # for cve in ['CVE-2018-15178']:
                file_components = self.cve_data_all[cve].get('components').get(component_type)
                collected_commit = self.cve_data_all[cve].get('collected_commit')

                res[cve] = {}
                for repo, commit in collected_commit:
                    repo_file_list = self.repo_file_list[repo][commit]
                    related_files = self.find_related_files(component_type, file_components, repo_file_list, k, similarity_algorithm)
                    res[cve][repo] = related_files

        res = {}
        multi_thread(cve_list, select_by_single_component_sub, chunk_size = 1800)
        # multi_thread(random.sample(cve_list, 10), select_by_component_sub, chunk_size = 50)
        save_json(res_path, res)
        return res
    

    def check_accuracy(self, data: dict, size: int):
        correct_count = 0
        total_count = 0
        for cve, v in data.items():
            # if not self.cve_data_all[cve]['collected_repo_correction']: continue
            if not self.cve_data_all[cve]['collected_commit_correction']: continue

            total_count += 1
            flag = False
            for _, triple_list in v.items():
                file_list = [item[1] for item in triple_list[:size]]
                ans_list = self.cve_data_all[cve]['files']
                if (any(file.lower() == ans.lower() for file in file_list for ans in ans_list)):
                    flag = True
                    # print(cve)
                    break 
            if flag:
                correct_count += 1
        
        print(size, ':{:.2f}%'.format(correct_count / total_count * 100), f'({correct_count}/{total_count})')      


    def find_related_files(self,  component_type: str, keywords: list, files: list, k: int, similarity_algorithm):
        # components中包含/则匹配完整路径，否则只匹配文件名
        res = []
        for keyword in keywords:
            for file, isdir in files:
                if isdir: continue
                file_lower = file.lower()
                keyword_lower = keyword.lower()
                if any(element in file_lower for element in self.filter_file_pattern): continue
                if any(file_lower.endswith(element) for element in self.filter_list_suffix): continue

                if component_type == 'File':
                    if '/' not in keyword:
                        keyword_lower = keyword.split('/')[-1]
                        file_lower = file.split('/')[-1]
                elif component_type == 'Module':
                    pass
                elif component_type == 'Function':
                    pass
                
                if similarity_algorithm.__name__ == 'SequenceMatcher':
                    similarity = difflib.SequenceMatcher(None, keyword_lower, file_lower).ratio()
                elif similarity_algorithm.__name__ == 'ngram_similarity':
                    similarity = ngram_similarity(keyword_lower, file_lower, 2)
                else:
                    similarity = similarity_algorithm(keyword_lower, file_lower)
                res.append((keyword, file, similarity))
        sorted_res = sorted(res, key = lambda x: x[2], reverse = (similarity_algorithm.__name__ != 'levenshtein_distance'))
        # sorted_res = sorted(res, key = lambda x: x[2])
        return sorted_res[:k]
    

    def select_by_file_and_function(self, k: int):
        cve_list = self.filter_cve_list(['File', 'Function'])
        res_path = f'{self.module_root_path}/candidates_with_\'File\', \'Function\']_component_{len(cve_list)}_{k}.json'
        if os.path.exists(res_path):
            return load_json(res_path)

        # print(len(cve_list))
        res = self.select_by_single_component('File', k, cve_list)
        # self.check_accuracy(res, 1)


        # tp_list = []
        new_res = {}
        # for cve in tqdm.tqdm(['CVE-2016-8858', 'CVE-2011-2906', 'CVE-2018-3739']):
        for cve in tqdm.tqdm(cve_list):
            new_res[cve] = {}
            for repo, sha in self.cve_data_all[cve]['collected_commit']:
                repo_update = repo.replace('/', '—')
                path = f'/Volumes/NVD/experiment_data/datasets/repository_clone/target/{cve}/{repo_update}'
                if not os.path.exists(path):
                    print('repo not exist', cve, repo)
                    # tp_list.append((cve, repo, sha))
                    continue
                
                new_res[cve][repo] = []
                for index, triple in enumerate(res[cve][repo]):
                    file_path = f'{path}/{triple[1]}'
                    # print(file_path)
                    if not os.path.islink(file_path) and not os.path.exists(file_path):
                        # print(file_path)
                        # print('error', cve, repo)
                        # tp_list.append((cve, repo, sha))
                        continue
                    if os.path.isdir(file_path): continue
                    if len(new_res[cve][repo]) < 3:
                        new_res[cve][repo].append(triple)
                        continue
                    try:
                        content = load_file(file_path).lower()
                        # TODO 这里只是简单的判断是否有这个函数名，有可能是函数调用，并不一定是函数定义
                        if any(function.lower() in content for function in self.cve_data_all[cve]['components']['Function']):
                            new_res[cve][repo].append(triple)
                            # print('yes', cve, repo, file_path)
                    except Exception as e:
                        # print(file_path, e)
                        pass
                    if len(new_res[cve][repo]) >= 4:
                        break

        # save_json(res_path, new_res)
        return new_res
        # print(len(tp_list))
        # save_text('test_module/cve_list_tp', tp_list)
        # save_pickle('test_module/cve_list_tp.pkl', tp_list)


    def test(self):
        cve_list = self.filter_cve_list(['Module'])
        total_count_1 = 0
        total_count_2 = 0
        total_count_3 = 0
        res_list = []
        res_correct_list = []
        correct_count = 0
        for cve in tqdm.tqdm(cve_list):
            module_components = self.cve_data_all[cve]['components']['Module']
            flag = False
            for repo, sha in self.cve_data_all[cve]['collected_commit']:
                for file, isdir in self.repo_file_list[(repo, sha)]:
                    if not isdir: continue
                    if any(file == module_name for module_name in module_components):
                        total_count_1 += 1
                        flag = True
                    if any(file.split('/')[-1] == module_name for module_name in module_components):
                        total_count_2 += 1
                        flag = True
                    if any(file.split('/')[-1].lower() == module_name.lower() for module_name in module_components):
                        total_count_3 += 1
                        flag = True
            if flag:
                res_list.append(cve)
                for file_ans in self.cve_data_all[cve]['files']:
                    if any(
                        module_name.lower() in item.lower()
                        for item in file_ans.split('/')
                        for module_name in module_components
                    ):
                        correct_count += 1
                        res_correct_list.append(cve)


        print(f'cve: {len(res_list)}/{len(cve_list)}')
        print(f'total_count_1: {total_count_1}')
        print(f'total_count_2: {total_count_2}')
        print(f'total_count_3: {total_count_3}')

        print(f'accuracy: {correct_count}/{len(res_list)}')

        save_text('test_module/cve_list_module', res_list)
        save_text('test_module/cve_correct_list_module', res_correct_list)
