import os
import sys
import tqdm
from util.io_util import load_pickle, save_text, save_json, save_pickle, load_json
from util.general_util import rule_based_filtering
from util.similarity_util import *
from util.general_util import rule_based_filtering


class ModuleSelection:

    def __init__(self, module_root_path: str, specified_repo_path: str, cve_data_all: dict, cve_list_done: list, repo_file_list: dict):
        self.module_root_path = module_root_path
        self.specified_repo_path = specified_repo_path
        self.cve_data_all = cve_data_all
        self.repo_file_list = repo_file_list

        os.makedirs(self.module_root_path, exist_ok = True)

        cve_list_path = f'{self.module_root_path}/cve_list'
        
        self.cve_list = [
            cve for cve in self.cve_data_all if
            'collected_commit' in self.cve_data_all[cve] and
            'components' in self.cve_data_all[cve] and
            'Module' in self.cve_data_all[cve]['components'] and
            cve not in cve_list_done
        ]
        save_text(cve_list_path, self.cve_list)
        save_pickle(f'{cve_list_path}.pkl', self.cve_list)
        print(len(self.cve_list))


    def filter_files(self):
        res_path = f'{self.module_root_path}/filtered_files'
        # if os.path.exists(f'{res_path}.pkl'):
        #     return load_pickle(f'{res_path}.pkl')
        
        # cnt = 0
        res = {}
        for cve in tqdm.tqdm(self.cve_list):
            # f = False
            for repo, sha in self.cve_data_all[cve]['collected_commit']:
                # vul_file = self.cve_data_all[cve]['collected_commit'][2]
                components = self.cve_data_all[cve]['components']['Module']
                filtered_files = set()
                # for item in vul_file.split('/')[:-1]:
                    # if item.lower() in self.cve_data_all[cve]['original_description'].lower():
                    #     f = True
                    # if 'complete_description' in self.cve_data_all[cve] and item.lower() in self.cve_data_all[cve]['complete_description'].lower():
                    #     f = True
                    # if any(item.lower() == component.lower() for component in self.cve_data_all[cve]['components']['Module']):
                    #     f = True
                for dir_path, isdir in self.repo_file_list[repo][sha]:
                    if not isdir: continue
                    
                    last = dir_path.split('/')[-1]
                    if any(last.lower() == component.lower() for component in components):
                        # f = True
                        repo_updated = repo.replace('/', 'â€”')
                        repo_path = f'{self.specified_repo_path}/{cve}/{repo_updated}'
                        for root_path, _, files in os.walk(f'{repo_path}/{dir_path}'):
                            for file in files:
                                full_path = f'{root_path}/{file}'
                                tp = len(f'{self.specified_repo_path}/{cve}/{repo_updated}/')
                                if rule_based_filtering(full_path[tp:]):
                                    filtered_files.add(full_path[tp:])
                if filtered_files:
                    if cve not in res:
                        res[cve] = {}
                    res[cve][repo] = list(filtered_files)
            # if f:
                # cnt += 1
                # tp.append(cve)
        # print(cnt)
        save_json(f'{res_path}.json', res)
        save_pickle(f'{res_path}.pkl', res)
        return res