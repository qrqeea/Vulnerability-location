import os
import re
import json
import tqdm
from util import save_text, save_pickle, load_pickle


def get_product(s):
    pattern = r'(?<=:)([^:]+):([^:]+):([^:]+):([^:]+):([^:]+):'
    match = re.search(pattern, s)
    if match:
        return match.group(4)
    else:
        return None


def get_cpe_products(cve_list: list, cpe_json_path: str, target_path: str):
    if os.path.exists(target_path):
        return load_pickle(f'{target_path}.pkl')
    
    res = {}
    files = os.listdir(cpe_json_path)
    for file in tqdm.tqdm(files):
        if file in ['.DS_Store']:
            continue
        
        # print(f"current file: {file}")
        fileName = f'{cpe_json_path}/{file}'
        with open(fileName, 'r', encoding='utf-8', errors='ignore') as f:
            data = json.load(f)['CVE_Items']
            # print(type(data))
            # print(len(data))
        for cve_dic in data:
            cve_id = cve_dic['cve']['CVE_data_meta']['ID']
            if cve_id not in cve_list: continue
            res[cve_id] = set()
            cpe_list = cve_dic['configurations']['nodes'][0]['cpe_match']
            if not cpe_list:
                # CVE-2021-31810
                # CVE-2014-9390
                # CVE-2022-29526
                cpe_list = cpe_list = cve_dic['configurations']['nodes'][0]['children'][0]['cpe_match']
            for cpe_dic in cpe_list:
                cpe = cpe_dic['cpe23Uri']
                res[cve_id].add(get_product(cpe))

    save_text(target_path, res)
    save_pickle(f'{target_path}.pkl', res)

    return res