import os
import json
from util import save_pickle, save_text, load_pickle


def filter_sub_datasets(save_to_file: str):
    '''
    筛选一部分数据作为测试集
    '''
    if os.path.exists(save_to_file):
        return load_pickle(f'{save_to_file}.pkl')
    
    cve_list = []
    cve_json_path = 'experiment_data/4571/cve_metadata'
    for file in os.listdir(cve_json_path):
        with open(f'{cve_json_path}/{file}', 'r', encoding='utf-8') as f:
            try:
                data = json.load(f)
            except Exception as e:
                print(f"open file {file} error")
            tp: dict = data['containers']['cna']
            
            if 'references' in tp.keys():
                references = tp['references']
                refNumber = len(references)
                if 7 < refNumber < 10:
                    cve_list.append(file.split('.')[0])
    cve_list.remove('CVE-2021-3778')    # 这个cve暂时无法补全，先手动remove
    # print(len(cve_list))
    if save_to_file:
        save_text(save_to_file, cve_list)
        save_pickle(f'{save_to_file}.pkl', cve_list)
    
    return cve_list

if __name__ == '__main__':
    filter_sub_datasets(save_to_file = 'experiment_data/267/cve_list')