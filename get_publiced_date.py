import os
import json
import tqdm
from datetime import datetime
from util import save_text, save_pickle, load_pickle


def get_publiced_date(cve_list: list, cpe_json_path: str, target_path: str):
    if os.path.exists(target_path):
        return load_pickle(f'{target_path}.pkl')
    
    res = {}
    files = os.listdir(cpe_json_path)
    for file in tqdm.tqdm(files):
        if file in ['.DS_Store']:
            continue
        
        # print(f"current file: {file}")
        fileName = f'{cpe_json_path}/{file}'
        with open(fileName, 'r', encoding='utf-8', errors='ignore') as f:
            data = json.load(f)['CVE_Items']
            # print(type(data))
            # print(len(data))
        for cve_dic in data:
            cve_id = cve_dic['cve']['CVE_data_meta']['ID']
            if cve_id not in cve_list: continue
            time = cve_dic.get('publishedDate')
            res[cve_id] = datetime.strptime(time, "%Y-%m-%dT%H:%MZ")

    save_text(target_path, res)
    save_pickle(f'{target_path}.pkl', res)

    return res

if __name__ == '__main__':
    cve_list = load_pickle('experiment_data/267/cve_list.pkl')
    get_publiced_date(
        cve_list = cve_list,
        cpe_json_path = 'experiment_data/all/cpe_json',
        target_path = 'experiment_data/267/{cve: published_date}'
    )