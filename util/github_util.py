import sys
import pytz
import json
import time
import base64
import requests
from datetime import datetime
from util.io_util import save_text, save_json, load_json

github_tokens = load_json('github_tokens.json')['github_tokens']


def check_api_limit(headers, tokens = ''):
    if 'X-RateLimit-Remaining' not in headers or 'X-RateLimit-Reset' not in headers:
        print(f'secondary rate limits!, token: {tokens}')
        time.sleep(300)
        return False
    remaining = headers['X-RateLimit-Remaining']
    reset_time = int(headers['X-RateLimit-Reset'])
    if int(remaining) == 0:
        reset_time_utc = datetime.utcfromtimestamp(reset_time)
        beijing_timezone = pytz.timezone('Asia/Shanghai')
        reset_time_beijing = reset_time_utc.replace(tzinfo=pytz.utc).astimezone(beijing_timezone)
        now_beijing = datetime.now(beijing_timezone)
        time_to_reset = (reset_time_beijing - now_beijing).total_seconds() + 2
        if time_to_reset > 50:
            print(time_to_reset, tokens)
        # print(f'剩余重置时间：{time_to_reset} seconds')
        if time_to_reset < 0:
            time_to_reset = 1
        time.sleep(time_to_reset)
    return True


def get_original_repo_name(repo_full_name: str, token: str):
    url = f"https://api.github.com/repos/{repo_full_name}"
    headers = {'Authorization': f'token {token}'}
    response = requests.get(url, headers = headers)
    check_api_limit(response.headers, token)
    if response.ok:
        repo = response.json()
        if 'parent' in repo.keys() and 'full_name' in repo['parent']:
            res = repo['parent']['full_name']
        else:
            res = repo_full_name
        return res
    else:
        # print(f"Failed to retrieve information for {repo_full_name}")
        return repo_full_name


def get_latest_repo_name(old_full_name, token: str):
    url = f'https://api.github.com/repos/{old_full_name}'
    headers = {'Authorization': f'token {token}'}
    response = requests.get(url, headers = headers)
    check_api_limit(response.headers, token)
    if response.ok:
        repo = response.json()
        res = repo['full_name'] if 'full_name' in repo.keys() else old_full_name
        return res
    else:
        # print(f"Failed to retrieve information for {old_full_name}")
        return old_full_name
    

def search_repo(params: dict, token: str):
    time.sleep(4)
    url = f'https://api.github.com/search/repositories'
    headers = {'Authorization': f'token {token}'}
    response = requests.get(url, headers = headers, params = params)
    check_api_limit(response.headers, token)
    if response.ok:
        data = response.json()
        repositories = data['items']
        return {repo['full_name'] for repo in repositories}
    return set()
    

def check_repo_exist(repo_full_name: str, token: str):
    url = f"https://api.github.com/repos/{repo_full_name}"
    headers = {'Authorization': f'token {token}'}
    response = requests.get(url, headers = headers)
    check_api_limit(response.headers, token)
    if response.ok:
        return True
    else:
        return False


def get_latest_commit_before_date(repo_full_name: str, date: str, token: str, branch = None):
    url = f'https://api.github.com/repos/{repo_full_name}/commits'
    if branch:
        url += f'?sha={branch}'
    headers = {'Authorization': f'token {token}'}
    params = {
        'per_page': 1,
        'until': date,
    }
    try:
        response = requests.get(url, params = params, headers = headers)
        if not check_api_limit(response.headers, token):
            response = requests.get(url, params = params, headers = headers)
            check_api_limit(response.headers, token)
        if response.ok:
            commits = response.json()
            if commits:
                return (commits[0]['sha'], commits[0]['commit']['committer']['date'])
    except Exception as e:
        save_text('error', e, 'a')
    return None


def get_all_branch(repo_full_name: str, token: str):
    url = f'https://api.github.com/repos/{repo_full_name}/branches'
    headers = {'Authorization': f'token {token}'}
    page = 1
    branches = []
    while True:
        params={'page': page, 'per_page': 100}
        response = requests.get(url, headers = headers, params = params)
        check_api_limit(response.headers, token)
        if response.ok:
            try:
                data = response.json()
                if len(data) == 0:
                    break
                branches += [branch['name'] for branch in data]
            except Exception as e:
                print('Error1', e)
                continue
        page += 1
    return branches
    

def get_file_list(repo_full_name: str, commit_sha: str, token: str, base_path = ''):
    url = f'https://api.github.com/repos/{repo_full_name}/git/trees/{commit_sha}?recursive=1'
    headers = {'Authorization': f'token {token}'}
    response = requests.get(url, headers = headers)
    check_api_limit(response.headers, token)
    if not response.ok:
        # print('Error2', response.text)
        return []
    try:
        # with open(f'{commit_sha}', 'w') as f:
        #     print(json.dumps(response.json()), file=f)
        data = response.json()
        if data['truncated']:
            url = url.split('?')[0]
            response = requests.get(url, headers = headers)
            check_api_limit(response.headers, token)
            if not response.ok:
                return []
            res = []
            for item in response.json()['tree']:
                if item['type'] == 'blob':
                    res.append((
                        base_path + '/' + item['path'] if base_path else item['path'],
                        item['type'] == 'tree'
                    ))
                elif item['type'] == 'tree':
                    res += get_file_list(
                        repo_full_name, item['sha'],
                        token,
                        base_path + '/' + item['path'] if base_path else item['path']
                    )
            # print(len(res))
            return res
        else:
            return [
                (base_path + '/' + item['path'] if base_path else item['path'], item['type'] == 'tree')
                for item in response.json()['tree']
            ]
    except Exception as e:
        print('Error1', e)
        return []


def get_file_content(repo_full_name: str, sha: str, file_path: str, token: str):
    url = f'https://api.github.com/repos/{repo_full_name}/contents/{file_path}?ref={sha}'
    headers = {'Authorization': f'token {token}'}
    response = requests.get(url, headers = headers)
    check_api_limit(response.headers, token)
    if response.ok:
        try:
            content = response.json().get('content', None)
            if content:
                content = base64.b64decode(content).decode('utf-8')
                return content
        except Exception as e:
            # print(repo_full_name, sha, file_path)
            pass
    # else:
    #     print(response.text)
    return None


if __name__ == '__main__':
    # repo_name = 'projectatomic/libpod'
    # repo_name = 'containers/podman'
    # repo_name = 'saitoha/libsixel'
    # repo_name = 'libsixel/libsixel'
    # repo_name = 'CESNET/libyang'
    repo_name = 'qrqeea/Vulnerability-location'

    # data = get_latest_commit_before_date(
    #     repo_name,
    #     '',
    #     github_tokens[0],
    # )
    # save_json('tp.json', data)
    # data = get_latest_commit_before_date(
    #     repo_name,
    #     "2015-07-20T23:59Z",
    #     '',
    #     ''
    # )
    data = get_file_content(
        'gpac/gpac',
        '',
        'src/scenegraph/mpeg4_nodes.c',
        github_tokens[0]
    )
    # print(data)
    # print(type(data))
    print(json.dumps(data))