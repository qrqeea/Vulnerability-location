import os
import tqdm
import random
from util.io_util import load_pickle, save_pickle, load_json, save_json, save_text, multi_thread
from util.github_util import github_tokens, get_file_content, get_file_list

class GroundTruth:

    def __init__(self, module_root_path: str, repo_data_path: str, original_gt: dict, commits_all: dict):
        self.module_root_path = module_root_path
        self.repo_data_path = repo_data_path
        self.original_gt = original_gt
        self.commits_all = commits_all

        os.makedirs(self.module_root_path, exist_ok = True)

        self.gt_file_content_dir = f'{self.module_root_path}/gt_file_content'
        os.makedirs(self.gt_file_content_dir, exist_ok = True)

    
    def start(self):
        cleaned_gt = self.clean_original_gt()
        gt = self.generate_new_gt(cleaned_gt)
        self.get_gt_file(gt)


    def clean_original_gt(self):
        path = f'{self.module_root_path}/cleaned_ground_truth.pkl'
        if os.path.exists(path):
            return load_pickle(path)

        error_cve_list = [
            'CVE-2016-9840.', 'CVE-2016-9841.', 'CVE-2016-9842.', 'CVE-2016-9843.', 'CVE-2013-6488', 'CVE-2022-0177', 'CVE-2022-0227', 'CVE-2022-0329', 'CVE-2015-3208', 'CVE-2009-5146', 'CVE-2017-1000384', 'CVE-2017-0605', 'CVE-2019-15601', 'CVE-2019-10124', 'CVE-2019-1010224', 'CVE-2019-1010222', 'CVE-2019-5428', 'CVE-2021-28421', 'CVE-2020-26159', 'CVE-2018-4700', 'CVE-2018-1000845', 'CVE-2018-19270', 'CVE-2011-1161', 'CVE-2016-1000023', 'CVE-2016-5483', 'CVE-2016-5875', 'CVE-2018-14178', 'CVE-2022-1884', 'CVE-2021-25635', 'CVE-2013-3364', 'CVE-2019-15690', 'CVE-2021-30492', 'CVE-2014-4920', 'CVE-2013-7035', 'CVE-2020-XXXX', 'CVE-2019-17669', 'CVE-2016-1000008', 'CVE-2016-1000273', 'CVE-2014-5244', 'CVE-2016-1000305', 'CVE-2015-3413', 'CVE-2014-6061', 'CVE-2016-1000230'
        ]
        keys = list(self.original_gt.keys())
        for cve, repo in keys:
            if cve in error_cve_list:
                del self.original_gt[cve, repo]

        key = ('CVE-2019-17669 ', 'WordPress/WordPress')
        self.original_gt[('CVE-2019-17669', 'WordPress/WordPress')] = self.original_gt[key]
        del self.original_gt[key]

        print(len(self.original_gt))    # 9390
        cve_list = {cve for cve, _ in self.original_gt}
        print(len(cve_list))    # 8978

        save_pickle(path, self.original_gt)
        return self.original_gt
    

    def generate_new_gt(self, cleaned_gt: dict):
        path = f'{self.module_root_path}/ground_truth'
        if os.path.exists(f'{path}.json'):
            return load_json(f'{path}.json')

        res = {}
        for (cve, repo), file in cleaned_gt.items():
            if cve not in res:
                res[cve] = {}
            if 'vulnerability_files' not in res[cve]:
                res[cve]['vulnerability_files'] = {}
            res[cve]['vulnerability_files'][repo] = list(file)
            
            if 'commits' not in res[cve]:
                commits = set()
                for _, v in self.commits_all[cve].items():
                    commits |= v
                res[cve]['commits'] = list(commits)

        res = self.manual_update_gt(res)

        save_json(f'{path}.json', res)
        save_pickle(f'{path}.pkl', res)
        return res


    def manual_update_gt(self, gt: dict):
        print(f'start update gt')
        # 添加一部分commit，便于找到gt文件内容
        gt['CVE-2018-17552']['commits'].append('https://github.com/rapid7/metasploit-framework/commit/f882c3aec2bbd15e7952dd7b133bcef947c46dd5')
        
        gt['CVE-2021-45861']['commits'].append('https://github.com/justdan96/tsMuxer/commit/5b8fdee725f8b4b2f8c5dd23da6bc1c05ee7a8f9')
        
        gt['CVE-2022-26980']['commits'].append('https://github.com/nilsteampassnet/TeamPass/commit/208ee63fbe757a778e1e8d0142864af30b357352')
        
        gt['CVE-2020-36277']['commits'].append('https://github.com/DanBloomberg/leptonica/commit/ac66835e9685a18231f0808d63fdc015a0efdc25')
        gt['CVE-2020-36277']['commits'].append('https://github.com/DanBloomberg/leptonica/commit/36f93b71ed0debf9c99f7967579fe851085084f0')
        
        gt['CVE-2019-11683']['commits'].append('https://github.com/torvalds/linux/commit/575b65bc5bff37ec502d5eab9fc91d0a8d5ec40e')
        
        gt['CVE-2019-14345']['commits'].append('https://github.com/tematres/TemaTres-Vocabulary-Server/commit/5e6c56147f736701755cc0de4a683e5f9b736ddc')
        
        gt['CVE-2019-8980']['commits'].append('https://github.com/torvalds/linux/commit/f612acfae86af7ecad754ae6a46019be9da05b8e')
        gt['CVE-2019-8980']['commits'].remove('https://github.com/krasCGQ/linux-vk/commit/f612acfae86af7ecad754ae6a46019be9da05b8e')
        
        gt['CVE-2019-12381']['commits'].append('https://github.com/torvalds/linux/commit/425aa0e1d01513437668fa3d4a971168bbaa8515')
        gt['CVE-2019-12381']['commits'].remove('https://github.com/krasCGQ/linux-vk/commit/425aa0e1d01513437668fa3d4a971168bbaa8515')
        
        gt['CVE-2022-34876']['commits'].append('https://github.com/rapid7/metasploit-framework/commit/794ce923ad4e8033b747272090289894797b2831')
        gt['CVE-2022-34877']['commits'].append('https://github.com/rapid7/metasploit-framework/commit/794ce923ad4e8033b747272090289894797b2831')
        gt['CVE-2022-34878']['commits'].append('https://github.com/rapid7/metasploit-framework/commit/794ce923ad4e8033b747272090289894797b2831')

        gt['CVE-2017-14705']['commits'].append('https://github.com/rapid7/metasploit-framework/commit/ee969ae8e579bfeba3508ef3db22144b3ad6bcfe')
        gt['CVE-2017-14706']['commits'].append('https://github.com/rapid7/metasploit-framework/commit/ee969ae8e579bfeba3508ef3db22144b3ad6bcfe')

        gt['CVE-2018-14028']['commits'].append('https://github.com/rastating/wordpress-exploit-framework/commit/19e3493522b434b09b5f2525792370482cdadea4')

        gt['CVE-2022-23837']['commits'].append('https://github.com/sidekiq/sidekiq/commit/7785ac1399f1b28992adb56055f6acd88fd1d956')
        gt['CVE-2022-23837']['commits'].remove('https://github.com/mperham/sidekiq/commit/7785ac1399f1b28992adb56055f6acd88fd1d956')
        gt['CVE-2022-23837']['commits'].remove('github.com/mperham/sidekiq/commit/7785ac1399f1b28992adb56055f6acd88fd1d956')

        gt['CVE-2020-7773']['commits'].append('https://github.com/valeriangalliat/markdown-it-highlightjs/commit/4f7b1c74eee7ac6ebe05f2e7a00c49232d86677e')

        gt['CVE-2021-37617']['commits'].append('https://github.com/nextcloud/desktop/commit/860514f01bcd3ef02b09e0e36e423d45a7dcfc93')

        gt['CVE-2020-14000']['commits'].append('https://github.com/scratchfoundation/scratch-vm/commit/90b9da45f4084958535338d1c4d71a22d6136aab')

        gt['CVE-2014-3868']['commits'].append('https://github.com/ZeusCart/zeuscart/commit/fa919a5e4887a7d348166eac4f10b041684208ca')

        gt['CVE-2021-3007']['commits'].append('https://github.com/laminas/laminas-http/commit/eab608e10896270416aae7ffce36cc48072aa796')

        gt['CVE-2017-7698']['commits'].append('https://github.com/matthiaskramm/swftools/commit/54ea46ce09ab2be15901240bf233845c92bf04af')

        gt['CVE-2018-14658']['commits'].append('https://github.com/keycloak/keycloak/commit/a957e118e6efb35fe7ef3a62acd66341a6523cb7')
        
        gt['CVE-2020-7351']['commits'].append('https://github.com/rapid7/metasploit-framework/commit/18ebf5efa6a5857f0f09487400b9f607ee97b599')

        gt['CVE-2017-17560']['commits'].append('https://github.com/rapid7/metasploit-framework/commit/d174ef3a7055d8d2ba2b809c14722dcbffa2510d')

        gt['CVE-2006-3082']['commits'].append('https://github.com/gpg/gnupg/commit/f081ad529d212be23aa5dd9d4bfb81282748e5eb')
        gt['CVE-2006-3082']['commits'].remove('https://github.com/GNOME/libxml2/commit/5dca9eea1bd4')

        gt['CVE-2006-0742']['commits'].append('https://github.com/torvalds/linux/commit/e963701a761aede31c9c1bfc74cf8e0ec671f0f4')
        gt['CVE-2006-0742']['commits'].remove('https://github.com/mono/mono/commit/d16d4623edb210635bec3ca3786481b82cde25a2')

        gt['CVE-2016-6128']['commits'].remove('https://github.com/libgd/libgd/commit/6ff72ae40c7c20ece939afb362d98cc37f4a1c96')
        gt['CVE-2016-6128']['commits'].remove('github.com/libgd/libgd/commit/f67452e1f82f1c2496e0859d638172bee74b43a0')
        gt['CVE-2016-6128']['commits'].remove('https://github.com/dreamsxin/async-php/commit/1d69028d2f15216d128b5a6e606f763ef09d4991')

        gt['CVE-2010-4176']['commits'].append('https://github.com/dracutdevs/dracut/commit/0a19e31886f98519386973354b429776ba7acb47')
        gt['CVE-2010-4176']['commits'].remove('https://github.com/postgres/postgres/commit/6ef325429cad60d7d24504fa25b5318fd4e35379')

        gt['CVE-2006-4790']['commits'].append('https://github.com/gnutls/gnutls/commit/c5c36a61fc8e0c2764a6818788344a9d79fdcad4')

        gt['CVE-2014-7156']['commits'].append('https://github.com/xen-project/xen/commit/7dfa94c6212b979cbfc8cff5ad5336922f4809d9')

        gt['CVE-2017-14199']['commits'].append('https://github.com/zephyrproject-rtos/zephyr/commit/3953714a9b8508aca72ab93991e8468ba508aa4b')

        gt['CVE-2014-4877']['commits'].append('https://github.com/rapid7/metasploit-framework/commit/64c206fa629b6dff3fa7ee2851323b35fa7e40c2')

        gt['CVE-2021-39171']['commits'].append('https://github.com/node-saml/passport-saml/commit/80e6fd65ef57e60212344796810f53be61248a73')

        gt['CVE-2014-5445']['commits'].append('https://github.com/rapid7/metasploit-framework/commit/98e416f6ec2b9c9fcc2caa9059a6f2350faff0d6')

        gt['CVE-2020-28500']['commits'].append('https://github.com/lodash/lodash/commit/02906b8191d3c100c193fe6f7b27d1c40f200bb7')

        gt['CVE-2020-27885']['commits'].append('https://github.com/wso2/carbon-apimgt/commit/4a0ec014f23ab86f805253628e7e73d8d83ecae2')

        gt['CVE-2020-23986']['commits'].append('https://github.com/anuraghazra/github-readme-stats/commit/0833e8531d0445dd461956b805e69a36d183f021')

        gt['CVE-2017-16043']['commits'].append('https://github.com/erming/shout/commit/6c852a849ae5c5375ba8ac0207c8c86e8bf0c148')

        gt['CVE-2021-21361']['commits'].append('https://github.com/bmuschko/gradle-vagrant-plugin/commit/ef9b8bfa468d8cd985c81e1e62357ecb96eed192')

        gt['CVE-2018-21034']['commits'].append('https://github.com/argoproj/argo-cd/commit/80751397c420d402d0e6315966f95329eb5d3285')

        gt['CVE-2018-20990']['commits'].append('https://github.com/alexcrichton/tar-rs/commit/d3d14ad5c32922444f857382976c22f056e3cef4')

        gt['CVE-2020-7385']['commits'].append('https://github.com/rapid7/metasploit-framework/commit/ba17a5d67fc9c2faecde66aaac21b7c976605060')

        gt['CVE-2020-25911']['commits'].append('https://github.com/modxcms/revolution/commit/1b7ffe02df30f05dbf67dd15e4d8101687c1585a')

        gt['CVE-2018-6849']['commits'].append('https://github.com/rapid7/metasploit-framework/commit/4671db55d076a78cff2ded23ba1621e49dee7c50')
        
        gt['CVE-2022-0532']['commits'].append('https://github.com/cri-o/cri-o/commit/1667b5a668a13e0a18ac4317fa13fa8a6865e73a')
        
        gt['CVE-2020-25575']['commits'].append('https://github.com/RustCrypto/hashes/commit/45f172cf8407e05cb9ed431f68663ad4f46b2325')

        gt['CVE-2021-31522']['commits'].append('https://github.com/apache/kylin/commit/2c8b3523beb34af8fb9345a59fe4b3deda3bb8d8')

        gt['CVE-2021-29133']['commits'].append('https://github.com/rapid7/metasploit-framework/commit/943698ef199674c118dc2a64359ae14b0fa8c8be')

        gt['CVE-2020-27386']['commits'].append('https://github.com/rapid7/metasploit-framework/commit/9417266d2125def4810a48cd5dbf065d83caeecc')

        gt['CVE-2020-10808']['commits'].append('https://github.com/rapid7/metasploit-framework/commit/c151b93ba4eafad7f8e75f248bd8a44510ba8b39')

        gt['CVE-2020-35909']['commits'].append('https://github.com/multiformats/rust-multihash/commit/26a296b871976d7d46325ce004207b8a6e27c946')

        gt['CVE-2019-15597']['commits'].append('https://github.com/adriano-di-giovanni/node-df/commit/98fd9a2e4287cdd1af0930d6c07e58a5524d013c')

        gt['CVE-2021-41181']['commits'].append('https://github.com/nextcloud/talk-android/commit/69bcd6ee880c4a096d8a944ea410034127bbe837')

        gt['CVE-2020-14445']['commits'].append('https://github.com/wso2/carbon-identity-framework/commit/d4dc5cfc835cde212aa60aafe20a2376b6d547a1')

        gt['CVE-2019-16142']['commits'].append('https://github.com/ebkalderon/renderdoc-rs/commit/cdc4276a7e3ec67185c2b66fcb7585ec8716de16')

        gt['CVE-2020-24703']['commits'].append('https://github.com/wso2/carbon-kernel/commit/d592582e32b5955733e19ff6d4d312be12c0e3d6')

        gt['CVE-2015-2582']['commits'].append('https://github.com/keycloak/keycloak/commit/0cb5ba0f6e83162d221681f47b470c3042eef237')

        gt['CVE-2018-20989']['commits'].append('https://github.com/briansmith/untrusted/commit/85e98d1c9d5ba8af623120e8fee6c97a2c2aee08')

        gt['CVE-2020-24706']['commits'].append('https://github.com/wso2/carbon-kernel/commit/a82efc854d23a2e2e8abeaf1af0b74bba279c414')

        gt['CVE-2020-35876']['commits'].append('https://github.com/spacejam/rio/commit/9088319e4d96e5e4ef120d666e0697cf27451285')

        gt['CVE-2016-3108']['commits'].append('https://github.com/pulp/pulp/commit/8f38e8989cce2949d6a152e97108c9a792e58e1a')
        
        gt['CVE-2022-31039']['commits'].append('https://github.com/bigbluebutton/greenlight/commit/d4edbe3808bfb5ffde36877b1499e8b37673793e')

        gt['CVE-2016-7415']['commits'].append('https://github.com/php/php-src/commit/6d55ba265637d6adf0ba7e9c9ef11187d1ec2f5b')
        
        gt['CVE-2020-10187']['commits'].append('https://github.com/rubysec/ruby-advisory-db/commit/96123aefeaf296036114b799938edaad5b6cb833')

        # 删除一些CVE，原因包括gt commit失效等
        del gt['CVE-2018-21021']
        del gt['CVE-2018-7589']
        del gt['CVE-2018-10813']
        del gt['CVE-2017-6213']
        del gt['CVE-2018-11587']
        del gt['CVE-2018-20200']
        del gt['CVE-2019-10051']
        del gt['CVE-2021-37157']
        del gt['CVE-2019-3846']
        del gt['CVE-2017-5336']
        del gt['CVE-2020-15801']
        del gt['CVE-2019-14802']
        del gt['CVE-2020-8933']
        del gt['CVE-2017-5335']
        del gt['CVE-2020-27642']
        del gt['CVE-2020-8907']
        del gt['CVE-2022-22294']
        del gt['CVE-2018-21022']
        del gt['CVE-2019-15298']
        del gt['CVE-2020-21054']
        del gt['CVE-2020-35514']
        del gt['CVE-2021-41188']
        del gt['CVE-2015-1560']
        del gt['CVE-2015-1561']
        del gt['CVE-2018-21020']
        del gt['CVE-2019-13024']
        del gt['CVE-2019-17106']
        del gt['CVE-2019-17107']
        del gt['CVE-2019-17108']
        del gt['CVE-2019-17105']
        del gt['CVE-2019-8912']
        del gt['CVE-2020-13252']
        del gt['CVE-2021-37556']
        del gt['CVE-2021-37557']
        del gt['CVE-2018-17198']
        del gt['CVE-2019-10670']
        del gt['CVE-2018-17553']
        del gt['CVE-2010-2247']
        del gt['CVE-2017-6441']
        del gt['CVE-2019-14343']
        del gt['CVE-2019-14344']
        del gt['CVE-2021-26601']
        del gt['CVE-2018-7890']
        del gt['CVE-2021-45385']
        del gt['CVE-2018-7562']
        del gt['CVE-2018-10966']
        del gt['CVE-2021-22571']
        del gt['CVE-2015-4645']
        del gt['CVE-2018-7563']
        del gt['CVE-2019-8956']
        del gt['CVE-2019-9857']
        del gt['CVE-2014-6287']
        del gt['CVE-2020-12725']
        del gt['CVE-2019-12615']
        del gt['CVE-2019-2101']
        del gt['CVE-2017-9070']
        del gt['CVE-2018-1000537']
        del gt['CVE-2020-13622']
        del gt['CVE-2019-12378']
        del gt['CVE-2019-12995']
        del gt['CVE-2022-28048']
        del gt['CVE-2021-43820']
        del gt['CVE-2021-22557']
        del gt['CVE-2019-16965']
        del gt['CVE-2018-7588']
        del gt['CVE-2019-2228']
        del gt['CVE-2017-11108']
        del gt['CVE-2019-12566']
        del gt['CVE-2019-19388']
        del gt['CVE-2004-1005']
        del gt['CVE-2019-18211']
        del gt['CVE-2013-4189']
        del gt['CVE-2022-24877']
        del gt['CVE-2020-21055']
        del gt['CVE-2006-6942']
        del gt['CVE-2020-21056']
        del gt['CVE-2019-16686']
        del gt['CVE-2021-44584']
        del gt['CVE-2014-4172']
        del gt['CVE-2017-18349']
        del gt['CVE-2022-24832']
        del gt['CVE-2020-14198']
        del gt['CVE-2020-8843']
        del gt['CVE-2021-32712']
        del gt['CVE-2018-20713']
        del gt['CVE-2017-5605']
        del gt['CVE-2022-23625']
        del gt['CVE-2021-42740']
        del gt['CVE-2019-19945']
        del gt['CVE-2021-32666']
        del gt['CVE-2019-1999']
        del gt['CVE-2016-10541']
        del gt['CVE-2020-7248']
        del gt['CVE-2020-7982']
        del gt['CVE-2015-9501']
        del gt['CVE-2017-5334']
        del gt['CVE-2019-12817']
        del gt['CVE-2019-18657']

        # 更新漏洞文件
        gt['CVE-2020-36277']['vulnerability_files']['DanBloomberg/leptonica'] = ['src/pixconv.c']
        
        # del gt['CVE-2022-24832']['vulnerability_files']['gocd/gocd']
        # gt['CVE-2022-24832']['vulnerability_files']['gocd/gocd-ldap-authentication-plugin'] = [
        #     'src/main/java/cd/go/apacheds/ApacheDsLdapClient.java',
        #     'src/main/java/cd/go/authentication/ldap/LdapClient.java',
        #     'src/main/java/cd/go/framework/ldap/JNDILdapClient.java',
        #     'src/test/java/cd/go/apacheds/ApacheDsLdapClientTest.java'
        # ]
        
        del gt['CVE-2018-14362']['vulnerability_files']['muttmua/mutt']
        gt['CVE-2018-14362']['vulnerability_files']['neomutt/neomutt'] = ['newsrc.c']
        
        del gt['CVE-2019-8980']['vulnerability_files']['krasCGQ/linux-vk']
        gt['CVE-2019-8980']['vulnerability_files']['torvalds/linux'] = ['fs/exec.c']
        
        del gt['CVE-2019-12381']['vulnerability_files']['krasCGQ/linux-vk']
        gt['CVE-2019-12381']['vulnerability_files']['torvalds/linux'] = ['net/ipv4/ip_sockglue.c']
        
        del gt['CVE-2022-23837']['vulnerability_files']['rubysec/ruby-advisory-db']
        gt['CVE-2022-23837']['vulnerability_files']['sidekiq/sidekiq'] = ['lib/sidekiq/web/application.rb']

        del gt['CVE-2020-14000']['vulnerability_files']['LLK/scratch-vm']
        gt['CVE-2020-14000']['vulnerability_files']['scratchfoundation/scratch-vm'] = ['src/serialization/sb3.js']
        
        del gt['CVE-2018-14658']['vulnerability_files']['TomMD/keycloak-keycloak']
        gt['CVE-2018-14658']['vulnerability_files']['keycloak/keycloak'] = ['services/src/main/java/org/keycloak/protocol/oidc/utils/RedirectUtils.java']

        del gt['CVE-2019-11683']['vulnerability_files']['krasCGQ/linux-vk']
        gt['CVE-2019-11683']['vulnerability_files']['torvalds/linux'] = ['net/ipv4/udp_offload.c']
        
        del gt['CVE-2006-3082']['vulnerability_files']['GNOME/libxml2']
        gt['CVE-2006-3082']['vulnerability_files']['gpg/gnupg'] = ['g10/parse-packet.c']

        del gt['CVE-2018-17142']['vulnerability_files']['marshmallow-code/marshmallow']
        gt['CVE-2018-17142']['vulnerability_files']['golang/net'] = ['html/parse.go']

        del gt['CVE-2016-6301']['vulnerability_files']['openntpd-portable/openntpd-openbsd']
        gt['CVE-2016-6301']['vulnerability_files']['mirror/busybox'] = ['networking/ntpd.c']

        del gt['CVE-2006-0188']['vulnerability_files']['ImageMagick/ImageMagick']
        del gt['CVE-2006-0188']['vulnerability_files']['ImageMagick/ImageMagick6']
        gt['CVE-2006-0188']['vulnerability_files']['RealityRipple/squirrelmail'] = ['src/webmail.php']
        
        del gt['CVE-2006-0742']['vulnerability_files']['mono/mono']
        gt['CVE-2006-0742']['vulnerability_files']['torvalds/linux'] = ['arch/ia64/kernel/unaligned.c']
        
        del gt['CVE-2016-6128']['vulnerability_files']['dreamsxin/async-php']
        gt['CVE-2016-6128']['vulnerability_files']['torvalds/linux'] = ['src/gd_crop.c']

        del gt['CVE-2010-4176']['vulnerability_files']['postgres/postgres']
        gt['CVE-2010-4176']['vulnerability_files']['dracutdevs/dracut'] = ['modules.d/50plymouth/plymouth-pretrigger.sh']
        
        del gt['CVE-2018-17552']['vulnerability_files']['rapid7/metasploit-framework']
        gt['CVE-2018-17552']['vulnerability_files']['NavigateCMS/Navigate-CMS'] = ['login.php']
        
        del gt['CVE-2022-28463']['vulnerability_files']['ImageMagick/ImageMagick6']

        del gt['CVE-2005-3857']['vulnerability_files']['aeroevan/android_kernel_asus_grouper']
        gt['CVE-2005-3857']['vulnerability_files']['torvalds/linux'] = ['fs/locks.c']
        
        del gt['CVE-2006-4790']['vulnerability_files']['ImageMagick/ImageMagick']
        gt['CVE-2006-4790']['vulnerability_files']['gnutls/gnutls'] = ['lib/x509/verify.c']

        del gt['CVE-2014-7156']['vulnerability_files']['torvalds/linux']
        # gt['CVE-2014-7156']['vulnerability_files']['xen-project/xen'] = ['xen/arch/x86/hvm/emulate.c', 'xen/arch/x86/x86_emulate/x86_emulate.c', 'xen/arch/x86/x86_emulate/x86_emulate.h']
        gt['CVE-2014-7156']['vulnerability_files']['xen-project/xen'] = ['xen/arch/x86/x86_emulate/x86_emulate.c']
        

        # 添加漏洞文件（漏洞文件和修复文件不同）
        gt['CVE-2019-11486']['vulnerability_files']['torvalds/linux'] = ['drivers/tty/n_r3964.c']
        gt['CVE-2021-3927']['vulnerability_files']['vim/vim'] = ['src/misc1.c']
        gt['CVE-2022-2206']['vulnerability_files']['vim/vim'] = ['src/message.c']
        gt['CVE-2018-11212']['vulnerability_files']['libjpeg-turbo/libjpeg-turbo'] = ['jmemmgr.c']
        gt['CVE-2018-11577']['vulnerability_files']['liblouis/liblouis'] = ['liblouis/logging.c']
        gt['CVE-2016-8866']['vulnerability_files']['ImageMagick/ImageMagick'] = ['MagickCore/memory.c']
        gt['CVE-2017-14642']['vulnerability_files']['axiomatic-systems/Bento4'] = ['Source/C++/System/StdC/Ap4StdCFileByteStream.cpp']
        gt['CVE-2019-1003003']['vulnerability_files']['jenkinsci/jenkins'] = ['core/src/main/java/hudson/security/TokenBasedRememberMeServices2.java']
        gt['CVE-2019-16255']['vulnerability_files']['ruby/ruby'] = ['lib/shell.rb']
        gt['CVE-2019-16255']['vulnerability_files']['ruby/shell'] = ['lib/shell.rb']
        gt['CVE-2017-12672']['vulnerability_files']['ImageMagick/ImageMagick6'] = ['coders/mat.c']
        gt['CVE-2022-33068']['vulnerability_files']['harfbuzz/harfbuzz'] = ['src/hb-ot-shape-fallback.cc']
        gt['CVE-2022-0080']['vulnerability_files']['mruby/mruby'] = ['mrbgems/mruby-compiler/core/codegen.c']
        gt['CVE-2020-19716']['vulnerability_files']['Exiv2/exiv2'] = ['src/types.cpp']
        gt['CVE-2016-1912']['vulnerability_files']['GPCsolutions/dolibarr'] = ['htdocs/user/card.php']
        gt['CVE-2021-40572']['vulnerability_files']['gpac/gpac'] = ['src/filters/reframe_av1.c']
        gt['CVE-2016-6207']['vulnerability_files']['dreamsxin/async-php'] = ['ext/gd/libgd/gd_interpolation.c']
        gt['CVE-2020-27750']['vulnerability_files']['ImageMagick/ImageMagick'] = ['MagickCore/colorspace-private.h']
        gt['CVE-2016-7522']['vulnerability_files']['ImageMagick/ImageMagick'] = ['MagickCore/locale.c']
        # 以下是代码生成
        gt['CVE-2020-27752']['vulnerability_files']['ImageMagick/ImageMagick'] = ['MagickCore/quantum-private.h']
        gt['CVE-2022-1927']['vulnerability_files']['vim/vim'] = ['src/mbyte.c']
        gt['CVE-2019-20632']['vulnerability_files']['gpac/gpac'] = ['src/odf/desc_private.c']
        gt['CVE-2019-14369']['vulnerability_files']['Exiv2/exiv2'] = ['src/pngimage.cpp']
        gt['CVE-2016-7537']['vulnerability_files']['ImageMagick/ImageMagick'] = ['MagickCore/memory.c']
        gt['CVE-2022-1851']['vulnerability_files']['vim/vim'] = ['src/misc1.c']
        gt['CVE-2017-15644']['vulnerability_files']['webmin/webmin'] = ['tunnel/link.cgi']
        gt['CVE-2016-8898']['vulnerability_files']['exponentcms/exponent-cms'] = ['framework/modules/ecommerce/controllers/cartController.php']
        gt['CVE-2021-22874']['vulnerability_files']['revive-adserver/revive-adserver'] = ['www/admin/userlog-index.php']
        gt['CVE-2015-4670']['vulnerability_files']['DevExpress/AjaxControlToolkit'] = ['AjaxControlToolkit/AjaxFileUpload/AjaxFileUploadHandler.cs']
        gt['CVE-2021-41750']['vulnerability_files']['nystudio107/craft-seomatic'] = ['src/models/jsonld/Guide.php']
        gt['CVE-2019-6502']['vulnerability_files']['OpenSC/OpenSC'] = ['src/libopensc/ctx.c']
        gt['CVE-2018-1000997']['vulnerability_files']['jenkinsci/jenkins'] =['core/src/main/java/hudson/util/Secret.java']
        gt['CVE-2020-27775']['vulnerability_files']['ImageMagick/ImageMagick'] =['MagickCore/quantum.h']
        gt['CVE-2020-27775']['vulnerability_files']['ImageMagick/ImageMagick6'] =['MagickCore/quantum.h']
        gt['CVE-2017-11163']['vulnerability_files']['Cacti/cacti'] =['aggregate_graphs.php']
        gt['CVE-2022-2210']['vulnerability_files']['vim/vim'] =['src/memline.c']
        gt['CVE-2022-30503']['vulnerability_files']['nginx/njs'] =['src/njs_value.h']
        gt['CVE-2007-5977']['vulnerability_files']['phpmyadmin/phpmyadmin'] =['db_create.php']
        gt['CVE-2022-0173']['vulnerability_files']['radareorg/radare2'] =['libr/util/buf.c']
        gt['CVE-2015-5063']['vulnerability_files']['silverstripe/silverstripe-framework'] =['dev/install/install.php']
        gt['CVE-2019-9640']['vulnerability_files']['whuangum/php-src'] =['sapi/fpm/fpm/fpm_main.c']
        gt['CVE-2022-2286']['vulnerability_files']['vim/vim'] =['src/change.c']
        gt['CVE-2021-29589']['vulnerability_files']['tensorflow/tensorflow'] =['tensorflow/lite/kernels/internal/reference/reference_ops.h']
        gt['CVE-2019-14464']['vulnerability_files']['milkytracker/MilkyTracker'] =['src/milkyplay/XMFile.cpp']
        gt['CVE-2017-9499']['vulnerability_files']['ImageMagick/ImageMagick'] =['MagickCore/pixel-accessor.h']
        gt['CVE-2022-0413']['vulnerability_files']['vim/vim'] =['src/charset.c']
        gt['CVE-2021-29279']['vulnerability_files']['gpac/gpac'] =['src/filter_core/filter_props.c']
        gt['CVE-2021-40571']['vulnerability_files']['gpac/gpac'] =['src/isomedia/box_code_apple.c']
        gt['CVE-2022-0713']['vulnerability_files']['radareorg/radare2'] =['libr/include/r_endian.h']
        gt['CVE-2016-5095']['vulnerability_files']['dreamsxin/async-php'] =['ext/standard/html.c']
        gt['CVE-2020-13902']['vulnerability_files']['ImageMagick/ImageMagick'] =['MagickCore/string.c']
        gt['CVE-2020-13902']['vulnerability_files']['ImageMagick/ImageMagick6'] =['MagickCore/string.c']
        gt['CVE-2021-30015']['vulnerability_files']['gpac/gpac'] =['src/filter_core/filter_pck.c']
        gt['CVE-2018-5703']['vulnerability_files']['sjp38/linux.personal'] =['net/ipv6/tcp_ipv6.c']
        gt['CVE-2022-1968']['vulnerability_files']['vim/vim'] =['src/mbyte.c']
        gt['CVE-2015-8019']['vulnerability_files']['ljalves/linux_media'] =['net/core/datagram.c']
        gt['CVE-2022-1286']['vulnerability_files']['mruby/mruby'] =['lib/mruby/gem.rb']
        gt['CVE-2022-1725']['vulnerability_files']['vim/vim'] =['src/regexp.c']
        gt['CVE-2017-12986']['vulnerability_files']['the-tcpdump-group/tcpdump'] =['print-rt6.c']
        gt['CVE-2016-8675']['vulnerability_files']['libav/libav'] =['libavcodec/get_bits.h']
        gt['CVE-2013-5984']['vulnerability_files']['microweber/microweber'] =['userfiles/modules/admin/backup/delete.php']
        gt['CVE-2020-35979']['vulnerability_files']['gpac/gpac'] =['src/ietf/rtp_pck_mpeg4.c']
        gt['CVE-2022-2284']['vulnerability_files']['vim/vim'] =['src/mbyte.c']
        gt['CVE-2018-10092']['vulnerability_files']['Dolibarr/dolibarr'] =['htdocs/core/class/antivir.class.php']
        gt['CVE-2017-11184']['vulnerability_files']['glpi-project/glpi'] =['front/item_devicesoundcard.form.php']
        gt['CVE-2016-10349']['vulnerability_files']['libarchive/libarchive'] =['libarchive/archive_endian.h']
        gt['CVE-2022-2182']['vulnerability_files']['vim/vim'] =['src/mbyte.c']
        gt['CVE-2021-46239']['vulnerability_files']['gpac/gpac'] =['src/utils/alloc.c']
        gt['CVE-2007-2245']['vulnerability_files']['phpmyadmin/phpmyadmin'] =['browse_foreigners.php']
        gt['CVE-2018-20549']['vulnerability_files']['cacalabs/libcaca'] =['caca/file.c']
        gt['CVE-2018-20449']['vulnerability_files']['sjp38/linux.personal'] =['drivers/dma/qcom/hidma_dbg.c']
        gt['CVE-2019-20630']['vulnerability_files']['gpac/gpac'] =['src/utils/bitstream.c']
        gt['CVE-2021-41682']['vulnerability_files']['jerryscript-project/jerryscript'] =['jerry-core/ecma/base/ecma-helpers-string.c']
        gt['CVE-2022-0318']['vulnerability_files']['vim/vim'] =['src/mbyte.c']
        gt['CVE-2021-44427']['vulnerability_files']['francoisjacquet/rosariosis'] =['Side.php']
        gt['CVE-2022-1620']['vulnerability_files']['vim/vim'] =['src/regexp.c']
        gt['CVE-2017-14638']['vulnerability_files']['axiomatic-systems/Bento4'] =['Source/C++/Core/Ap4Atom.h']
        gt['CVE-2017-9839']['vulnerability_files']['Dolibarr/dolibarr'] =['htdocs/product/stats/card.php']
        gt['CVE-2021-45861']['vulnerability_files']['justdan96/tsMuxer'] =['tsMuxer/bitStream.h']
        gt['CVE-2015-1471']['vulnerability_files']['delta/pragyan'] =['cms/userprofile.lib.php']
        gt['CVE-2018-6616']['vulnerability_files']['uclouvain/openjpeg'] =['src/lib/openjp2/t1.c']
        gt['CVE-2019-20631']['vulnerability_files']['gpac/gpac'] =['src/utils/list.c']
        gt['CVE-2018-1152']['vulnerability_files']['libjpeg-turbo/libjpeg-turbo'] =['jmemmgr.c']
        gt['CVE-2016-8595']['vulnerability_files']['FFmpeg/FFmpeg'] =['libavcodec/gsm_parser.c']
        gt['CVE-2017-15645']['vulnerability_files']['webmin/webmin'] =['at/create_job.cgi']
        gt['CVE-2019-1010176']['vulnerability_files']['jerryscript-project/jerryscript'] =['jerry-core/lit/lit-char-helpers.c']
        gt['CVE-2015-7799']['vulnerability_files']['ljalves/linux_media'] =['drivers/net/slip/slhc.c']
        gt['CVE-2022-26980']['vulnerability_files']['nilsteampassnet/TeamPass'] =['index.php']
        gt['CVE-2018-10821']['vulnerability_files']['BlackCatDevelopment/BlackCatCMS'] =['upload/backend/pages/modify.php']
        gt['CVE-2022-1898']['vulnerability_files']['vim/vim'] =['src/search.c']
        gt['CVE-2022-2231']['vulnerability_files']['vim/vim'] =['src/charset.c']
        gt['CVE-2016-8677']['vulnerability_files']['ImageMagick/ImageMagick'] =['MagickCore/quantum.c']
        gt['CVE-2016-9556']['vulnerability_files']['ImageMagick/ImageMagick'] =['MagickCore/pixel-accessor.h']
        gt['CVE-2016-8862']['vulnerability_files']['ImageMagick/ImageMagick'] =['MagickCore/memory.c']
        gt['CVE-2010-2248']['vulnerability_files']['malvira/lpc31xx'] =['mm/filemap.c']
        gt['CVE-2021-40573']['vulnerability_files']['gpac/gpac'] =['src/utils/list.c']
        # gt['CVE-2021-40573']['vulnerability_files']['gpac/gpac'] =['src/utils/alloc.c']
        gt['CVE-2017-7859']['vulnerability_files']['FFmpeg/FFmpeg'] =['libavcodec/h264dec.c']
        gt['CVE-2022-0284']['vulnerability_files']['ImageMagick/ImageMagick'] =['MagickCore/pixel-accessor.h']
        gt['CVE-2011-4962']['vulnerability_files']['silverstripe/silverstripe-cms'] =['code/sitefeatures/PageCommentInterface.php']
        gt['CVE-2020-5298']['vulnerability_files']['octobercms/october'] =['modules/cms/widgets/AssetList.php']
        gt['CVE-2018-5785']['vulnerability_files']['uclouvain/openjpeg'] =['src/lib/openjp2/j2k.c']
        gt['CVE-2021-29546']['vulnerability_files']['tensorflow/tensorflow'] =['tensorflow/core/kernels/quantization_utils.h']
        gt['CVE-2022-1674']['vulnerability_files']['vim/vim'] =['src/regexp.c']
        gt['CVE-2022-30976']['vulnerability_files']['gpac/gpac'] =['CVE-2022-30976']
        gt['CVE-2022-28463']['vulnerability_files']['ImageMagick/ImageMagick'] =['MagickCore/quantum-import.c']
        gt['CVE-2022-1115']['vulnerability_files']['ImageMagick/ImageMagick6'] =['magick/quantum-private.h']
        gt['CVE-2020-11052']['vulnerability_files']['Sorcery/sorcery'] =['lib/sorcery/controller/submodules/brute_force_protection.rb']
        gt['CVE-2022-1284']['vulnerability_files']['radareorg/radare2'] =['libr/reg/reg.c']
        gt['CVE-2018-19797']['vulnerability_files']['sass/libsass'] =['src/memory/SharedPtr.hpp']
        # gt['CVE-2018-19797']['vulnerability_files']['sass/libsass'] =['src/ast_selectors.cpp']
        # gt['CVE-2018-19797']['vulnerability_files']['sass/libsass'] =['src/ast.cpp']
        gt['CVE-2014-9089']['vulnerability_files']['mantisbt/mantisbt'] =['view_all_bug_page.php']
        # gt['CVE-2014-9089']['vulnerability_files']['mantisbt/mantisbt'] =['view_all_set.phpp']
        # gt['CVE-2013-6395']['vulnerability_files']['ganglia/ganglia-web'] =['get_context.php']
        gt['CVE-2013-6395']['vulnerability_files']['ganglia/ganglia-web'] =['header.php']
        # gt['CVE-2017-14225']['vulnerability_files']['FFmpeg/FFmpeg'] =['libavcodec/utils.c']
        gt['CVE-2017-14225']['vulnerability_files']['FFmpeg/FFmpeg'] =['libavutil/pixdesc.c']
        gt['CVE-2021-22889']['vulnerability_files']['revive-adserver/revive-adserver'] =['www/admin/stats.php']

        print(f'end update gt, size: {len(gt)}')
        return gt

    def get_gt_file(self, gt: dict):
        if os.path.exists(f'{self.module_root_path}/gt_content_to_scrapy_list'):
            return
        
        to_scrapy_list = set()
        for cve, v in gt.items():
            for repo, files in v['vulnerability_files'].items():
                for url in v['commits']:
                    if f'github.com/{repo}/commit/' not in url:
                        continue
                    sha = url[url.find('/commit/') + 8:]
                    to_scrapy_list |= {(cve, repo, file, sha) for file in files}
        save_text(f'{self.module_root_path}/gt_content_to_scrapy_list', to_scrapy_list)
        print(f'to_scrapy_list size: {len(to_scrapy_list)}')
         
        def get_gt_file_sub(to_scrapy_list_sub: list, token: str):
            for (cve, repo, file, sha) in tqdm.tqdm(to_scrapy_list_sub):
                dir = f'{self.gt_file_content_dir}/{cve}'
                tp1 = repo.replace('/', '\\')
                tp2 = file.replace('/', '\\')
                save_path = f'{dir}/{tp1}____{tp2}'
                if os.path.exists(save_path):
                    continue
                res = get_file_content(repo, sha, file, token)
                if res:
                    # print(save_path)
                    os.makedirs(dir, exist_ok = True)
                    save_text(save_path, res)
                else:
                    # 没爬到文件的一个原因是大小写问题
                    if repo not in repo_file_list:
                        repo_file_list[repo] = {}
                    if sha not in repo_file_list:
                        repo_file_list[repo][sha] = get_file_list(repo, sha, token)
                    file_list = repo_file_list[repo][sha]
                    for file2, _ in file_list:
                        if file.lower() == file2.lower():
                            res = get_file_content(repo, sha, file2, token)
                            if res:
                                os.makedirs(dir, exist_ok = True)
                                save_text(save_path, res)
                            break
        # get_gt_file_sub(
        #     [(
        #         'CVE-2019-8424',
        #         'ZoneMinder/zoneminder',
        #         'web/ajax/status.php',
        #         '02fd1e79b3bfa5b2e2087cb1255f9dbd921ccae8'
        #     )], 
        #     github_tokens[0]
        # )

        repo_file_list = load_pickle(f'{self.repo_data_path}/repo_file_list.pkl')
        # multi_thread(random.sample(list(to_scrapy_list), 10), get_gt_file_sub, tokens = github_tokens)
        multi_thread(list(to_scrapy_list), get_gt_file_sub, tokens = github_tokens)

        save_json(f'{self.repo_data_path}/repo_file_list.json', repo_file_list)
        save_pickle(f'{self.repo_data_path}/repo_file_list.pkl', repo_file_list)